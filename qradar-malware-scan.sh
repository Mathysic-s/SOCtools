#!/bin/bash
#QRadar Custom Action - Cortex XDR Malware Scan
#Version v0.2 by alan7s

cortex_responder_api=$1 #Fixed Property
cortex_responder_id=$2 #Fixed Property
cortex_fqdn=$3 #Fixed Property
local_ip=$4 #Network Event Property -> sourceip
qradar_token="SEC: $5" #Fixed Property
qradar_ip=$6 #Fixed Property
qradar_comment=$7 #Fixed Property -> encoded string

echo "Trying to do a malware scan at" $local_ip

output=$(curl --request POST \
  --url https://api-$cortex_fqdn.xdr.us.paloaltonetworks.com/public_api/v1/endpoints/scan \
  --header "x-xdr-auth-id: $cortex_responder_id" \
  --header "Authorization: $cortex_responder_api" \
  --header "Accept: application/json" \
  --header "Content-Type: application/json" \
  --data '{ "request_data": {
        "filters": [
            {
                "field": "ip_list",
                "value": ["'"$local_ip"'"],
                "operator": "in"
            }
        ]
    } }')
echo $output

qradar_get_url="https://$qradar_ip/api/siem/offenses?filter=status%3Dopen"
echo $qradar_get_url
response=$(curl -S -X GET -H 'Version: 21.0' -H "${qradar_token}" -H 'Content-Type: application/json' -H 'Accept: application/json' -k $qradar_get_url)
ids=$(echo "$response" | grep -o '"credibility":[0-9]*,"id":[0-9]*' | cut -d':' -f3)
arr_id=($ids)
offense_ip=$(echo "$response" | grep -o '"offense_source":"[^"]*"' | cut -d':' -f2 | tr -d '"')
arr_ip=($offense_ip)
for i in "${!arr_ip[@]}"
do
    if [[ "${arr_ip[$i]}" == "$local_ip" ]]; then
        echo "Offense $i contains $local_ip"
        id=${arr_id[$i]}
        qradar_post_url="https://$qradar_ip/api/siem/offenses/$id/notes?note_text=$qradar_comment"
        echo "Trying to add comment"
        res=$(curl -S -X POST -H "${qradar_token}" -k $qradar_post_url)
    fi
done
